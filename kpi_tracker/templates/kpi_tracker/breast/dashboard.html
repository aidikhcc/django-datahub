{% extends 'kpi_tracker/breast/base.html' %}
{% load static %}

{% block breast_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@14.6.3/distribute/nouislider.min.css">
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<style>
    /* Update container styles */
    .container-fluid {
        padding: 0.75rem !important;  /* Add minimal balanced padding */
    }

    /* Adjust body padding for sidebar */
    body.has-sidebar {
        padding-left: 220px !important;  /* Match sidebar width */
    }

    /* Make sidebar more compact */
    .sidebar {
        width: 220px !important;
    }

    /* Adjust card margins and padding */
    .card {
        margin-bottom: 0.75rem !important;  /* Match container padding */
        border-radius: 4px !important;      /* Subtle rounded corners */
    }

    .card-header {
        padding: 0.75rem !important;
    }

    .card-body {
        padding: 0.75rem !important;
    }

    /* Adjust row spacing */
    .row {
        margin-right: -0.375rem !important;  /* Half of container padding */
        margin-left: -0.375rem !important;
    }

    /* Adjust column spacing */
    [class*="col-"] {
        padding-right: 0.375rem !important;  /* Half of container padding */
        padding-left: 0.375rem !important;
    }

    /* Adjust spacing for filter section */
    .mb-4 {
        margin-bottom: 0.75rem !important;  /* Match container padding */
    }

    /* Make charts fill their containers better */
    .chart-container {
        height: 220px !important;
        margin-bottom: 0 !important;
    }

    /* Remove any extra spacing from main content */
    .main-content {
        padding: 0 !important;
        margin: 0 !important;
    }

    /* Adjust disease header spacing */
    .disease-header {
        margin-bottom: 0.75rem !important;
        padding: 0.75rem !important;
    }

    /* Rest of your existing styles... */

    /* Adjust modal chart size */
    .chart-container-large {
        height: 600px !important;  /* Increase modal chart height */
    }

    .chart-container {
        height: 200px;
        position: relative;
        cursor: pointer;
        transition: opacity 0.2s ease;
    }

    .chart-container:hover {
        opacity: 0.8;
    }

    .chart-container-large {
        width: 100%;
        height: 500px;
    }

    .card-header .fa-undo {
        font-size: 0.875rem;
        color: #6c757d;
    }

    .card-header .fa-undo:hover {
        color: #495057;
    }

    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid rgba(0,0,0,.125);
    }

    .form-label.small {
        font-size: 0.75rem;
        margin-bottom: 0.25rem;
        color: #6c757d;
    }

    .input-group-sm > .form-control,
    .input-group-sm > .input-group-text {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }

    .form-select-sm {
        padding-top: 0.25rem;
        padding-bottom: 0.25rem;
        font-size: 0.875rem;
    }

    .card.mb-3 {
        box-shadow: none;
        border: 1px solid rgba(0,0,0,.125);
    }

    .card.mb-3 .card-header {
        background-color: transparent;
    }

    .btn-outline-primary {
        padding: 0.25rem 0.75rem;
        font-size: 0.875rem;
    }

    .fa-undo.small {
        font-size: 0.75rem;
    }

    .badge.bg-light {
        font-size: 0.875rem;
        padding: 0.4rem 0.6rem;
        border: 1px solid rgba(0,0,0,.125);
    }

    .delay-reasons {
        font-size: 0.875rem;
    }

    .delay-reasons .badge {
        font-size: 0.75rem;
        font-weight: normal;
    }

    .text-truncate {
        max-width: 150px;
        color: #333;
    }
    /* Add to your existing CSS */
    .chart-container {
        position: relative;
    }

    .chart-container::after {
        content: 'Double-click to enlarge';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        opacity: 0;
        transition: opacity 0.2s ease;
        pointer-events: none;
    }

    .chart-container:hover::after {
        opacity: 1;
    }

    /* Date Range Slider Styles */
    .date-range-slider {
        height: 40px;
        padding: 15px 10px;
        margin: 10px 0;
    }

    .noUi-target {
        background: #e9ecef;
        border: none;
        box-shadow: none;
        height: 2px;
    }

    .noUi-connect {
        background: #605E5C;
    }

    .noUi-horizontal .noUi-handle {
        width: 12px !important;
        height: 12px !important;
        border-radius: 50%;
        background-color: #605E5C;
        border: none;
        box-shadow: none;
        cursor: pointer;
        right: -6px !important;
        top: -5px !important;
    }

    .noUi-handle:before,
    .noUi-handle:after {
        display: none;
    }

    .date-range-values {
        display: flex;
        justify-content: space-between;
        margin-top: 8px;
        font-size: 12px;
        color: #605E5C;
    }

    .date-range-values span {
        padding: 2px 6px;
        background: #f8f9fa;
        border-radius: 3px;
        border: 1px solid #dee2e6;
    }
</style>
{% endblock %}

{% block breast_content %}
<div class="container-fluid">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-2">Updating Dashboard...</div>
        </div>
    </div>

    <!-- Add Snapshot Button -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">Breast Cancer Dashboard</h4>
        <button id="snapshotDashboardBtn" class="btn btn-outline-primary btn-sm">
            <i class="fas fa-camera me-1"></i>Snapshot Dashboard
        </button>
    </div>

    <!-- Total Entries Counter -->
    <div class="row mb-4">
        <!-- Total Entries -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="text-muted mb-2">Total Entries</h6>
                            <h4 class="mb-0">
                                <i class="fas fa-database me-2"></i>
                                <span class="badge bg-primary">{{ total_all }}</span>
                            </h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Completed Entries -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="text-muted mb-2">Completed Entries</h6>
                            <h4 class="mb-0">
                                <i class="fas fa-check-circle me-2"></i>
                                <span class="badge bg-success">{{ total_patients }}</span>
                            </h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pending Entries -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="text-muted mb-2">Pending Entries</h6>
                            <h4 class="mb-0">
                                <i class="fas fa-clock me-2"></i>
                                <span class="badge bg-warning">{{ total_pending }}</span>
                            </h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Form -->
    <div class="card mb-4">
        <div class="card-header py-2">
            <div class="d-flex justify-content-between align-items-center">
                <a href="#filterCollapse" 
                   class="text-decoration-none text-dark d-flex align-items-center" 
                   data-bs-toggle="collapse" 
                   role="button" 
                   aria-expanded="false" 
                   aria-controls="filterCollapse">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-filter me-2"></i>Filters
                    </h6>
                    <i class="fas fa-chevron-down ms-2 small"></i>
                </a>
                <div>
                    <button type="button" class="btn btn-sm btn-outline-secondary me-2" onclick="clearFilters()">
                        <i class="fas fa-undo small"></i>
                    </button>
                    <button type="submit" form="filterForm" class="btn btn-sm btn-outline-primary">Apply</button>
                </div>
            </div>
        </div>
        <div class="collapse" id="filterCollapse">
            <div class="card-body py-2">
                <form id="filterForm" class="row g-2 align-items-end" method="GET">
                    <!-- Date Range -->
                    <div class="col-md-3">
                        <div class="row">
                            <div class="col-6">
                                <label class="form-label small mb-1">Start Date</label>
                                <input type="date" id="startDate" name="startDate" class="form-control form-control-sm">
                            </div>
                            <div class="col-6">
                                <label class="form-label small mb-1">End Date</label>
                                <input type="date" id="endDate" name="endDate" class="form-control form-control-sm">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gender -->
                    <div class="col-md-1">
                        <label class="form-label small mb-1">Gender</label>
                        <select name="gender" class="form-select form-select-sm">
                            <option value="">All</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                    
                    <!-- Nationality -->
                    <div class="col-md-2">
                        <label class="form-label small mb-1">Nationality</label>
                        <select name="nationality" class="form-select form-select-sm">
                            <option value="">All</option>
                            {% for nat in demographics.nationality %}
                                <option value="{{ nat.nationality }}">{{ nat.nationality }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Doctors -->
                    <div class="col-md-2">
                        <label class="form-label small mb-1">Oncologist</label>
                        <select name="oncologist" class="form-select form-select-sm">
                            <option value="">All</option>
                            {% for doc in doctors.oncologists %}
                                <option value="{{ doc.Oncologist_name }}">{{ doc.Oncologist_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-2">
                        <label class="form-label small mb-1">Surgeon</label>
                        <select name="surgeon" class="form-select form-select-sm">
                            <option value="">All</option>
                            {% for doc in doctors.surgeons %}
                                <option value="{{ doc.Surgeon_name }}">{{ doc.Surgeon_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-2">
                        <label class="form-label small mb-1">Radiotherapist</label>
                        <select name="radiotherapist" class="form-select form-select-sm">
                            <option value="">All</option>
                            {% for doc in doctors.radiotherapists %}
                                <option value="{{ doc.Radiotherapist_name }}">{{ doc.Radiotherapist_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add this debug section temporarily -->
    <div class="d-none">
        <pre>
            New Cases Trend: {{ new_cases_trend }}
            Demographics: {{ demographics }}
            Delay Distribution: {{ delay_distribution }}
            Delay Reasons: {{ delay_reasons }}
        </pre>
    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <!-- New Cases Trend -->
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <h4 class="card-title mb-0">New Cases Trend</h4>
                        <div class="ms-3 d-flex align-items-center">
                            <span class="badge bg-light text-dark">
                                <i class="fas fa-users me-1"></i>
                                Total: <span id="totalPatientsCount">{{ total_patients }}</span>
                            </span>
                        </div>
                    </div>
                    <button class="btn btn-sm p-0" onclick="downloadChartData('newCases')">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="newCasesTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Population Pyramid -->
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="card-title mb-0">Age & Gender Distribution</h4>
                    <button class="btn btn-sm p-0" onclick="downloadChartData('ageGender')">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="populationPyramidChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nationality -->
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="card-title mb-0">Nationality Distribution</h4>
                    <button class="btn btn-sm p-0" onclick="downloadChartData('nationality')">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="nationalityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Treatment KPI Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h4 class="card-title mb-1">Time to Start Treatment KPI</h4>
                            <div class="small text-muted">
                                <a class="text-muted text-decoration-none" data-bs-toggle="collapse" href="#kpiDetails" role="button" aria-expanded="false">
                                    <i class="fas fa-info-circle me-1"></i>View Definition & Calculation
                                </a>
                            </div>
                        </div>
                        <button class="btn btn-sm p-0" onclick="downloadChartData('treatmentKPI')">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- KPI Metrics -->
                        <div class="col-md-4">
                            <div class="row">
                                <!-- Average Days -->
                                <div class="col-12 mb-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="text-muted mb-1">Average Days to Treatment</h6>
                                            <h3 class="mb-0" id="avgDays">{{ treatment_kpi.avg_days|floatformat:1 }}</h3>
                                        </div>
                                        <span class="badge rounded-pill {% if treatment_kpi.avg_days <= 31 %}bg-success{% else %}bg-danger{% endif %}">
                                            {{ treatment_kpi.avg_days|floatformat:1 }} vs 31
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Achievement Rate -->
                                <div class="col-12">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="text-muted mb-1">Achievement Rate</h6>
                                            <h3 class="mb-0" id="achievementRate">{{ treatment_kpi.percentage|floatformat:1 }}</h3>
                                            <div class="text-muted small">
                                                ({{ treatment_kpi.within_target }}/{{ treatment_kpi.total }} patients)
                                            </div>
                                        </div>
                                        <span class="badge rounded-pill {% if treatment_kpi.percentage >= 80 %}bg-success{% else %}bg-danger{% endif %}">
                                            {{ treatment_kpi.percentage|floatformat:1 }}% vs 80%
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Delay Distribution Chart -->
                        <div class="col-md-8">
                            <div class="row">
                                <!-- Histogram -->
                                <div class="col-md-8">
                                    <div class="chart-container" style="height: 200px;">
                                        <canvas id="delayDistributionChart"></canvas>
                                    </div>
                                </div>
                                <!-- Delay Reasons -->
                                <div class="col-md-4">
                                    <h6 class="text-muted mb-3">Top Delay Reasons</h6>
                                    <div class="delay-reasons" style="height: 200px; overflow-y: auto;">
                                        <div id="delayReasonsList">
                                            {% for reason in delay_reasons %}
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <div class="text-truncate me-2" title="{{ reason.reason }}">
                                                    {{ reason.reason }}
                                                </div>
                                                <div class="text-end">
                                                    <span class="badge bg-secondary">
                                                        {{ reason.count }} ({{ reason.percentage|floatformat:1 }}%)
                                                    </span>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Add this inside the Treatment KPI Card, after the card header -->
                <div class="collapse" id="kpiDetails">
                    <div class="card-body bg-light border-top">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="mb-3">Definition</h6>
                                <ul class="small text-muted list-unstyled">
                                    <li class="mb-2">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Time from insurance approval date to first treatment date
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-check-circle me-2"></i>
                                        Target: Within 31 days
                                    </li>
                                    <li>
                                        <i class="fas fa-bullseye me-2"></i>
                                        Achievement Rate Target: 80%
                                    </li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6 class="mb-3">Calculation Method</h6>
                                <ul class="small text-muted list-unstyled">
                                    <li class="mb-2">
                                        <i class="fas fa-calculator me-2"></i>
                                        Average Days = Average(Treatment Date - Insurance Date)
                                    </li>
                                    <li>
                                        <i class="fas fa-percentage me-2"></i>
                                        Achievement Rate = (Cases within 31 days / Total cases) Ã— 100
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart Modals -->
    <div class="modal fade" id="chartModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"></h5>
                    <div class="ms-auto">
                        <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="copyChartToClipboard()">
                            <i class="fas fa-camera me-1"></i>Snapshot
                        </button>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="chart-container-large">
                        <canvas id="modalChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block breast_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="https://cdn.jsdelivr.net/npm/nouislider@14.6.3/distribute/nouislider.min.js"></script>
<script>
// Add these declarations at the global scope (before DOMContentLoaded)
let formFilters; // Declare formFilters in global scope
let filterState; // Declare filterState in global scope

// Define clearFilters in global scope
function clearFilters() {
    // Show loading indicator
    toggleLoading(true);
    
    // Get the form
    const form = document.getElementById('filterForm');
    
    // Reset all form fields
    form.reset();
    
    // Reset all select elements explicitly
    form.querySelectorAll('select').forEach(select => {
        select.value = '';
    });
    
    // Call formFilters.applyFilters directly instead of dispatching an event
    if (formFilters) {
        formFilters.applyFilters();
    }
    
    // Also reset the filterState if it exists
    if (filterState) {
        filterState.nationality = null;
        filterState.updateCharts();
    }
}

// Add this function at the global scope (outside DOMContentLoaded)
function toggleLoading(show) {
    const loadingOverlay = document.getElementById('loadingOverlay');
    if (loadingOverlay) {
        loadingOverlay.style.display = show ? 'block' : 'none';
    }
}

// Add this at the top of your script section
let html2canvasLoaded = false;

// Update the script loading part in DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
    // Register the datalabels plugin
    Chart.register(ChartDataLabels);

    try {
        // Parse the data from Django context with proper error handling
        const newCasesTrendData = JSON.parse('{{ new_cases_trend|escapejs }}');
        const nationalityData = {{ demographics.nationality|safe }};  // This is already JSON
        const genderData = JSON.parse('{{ demographics.gender|escapejs }}');
        const ageGroupsData = JSON.parse('{{ demographics.age_groups|escapejs }}');
        const delayDistributionData = JSON.parse('{{ delay_distribution|escapejs }}');
        const delayReasonsData = {{ delay_reasons|safe }};  // This is already JSON

        // Initialize charts
        const charts = {};

        // New Cases Trend Chart
        if (document.getElementById('newCasesTrendChart')) {
            charts.newCasesTrend = new Chart(
                document.getElementById('newCasesTrendChart'),
                {
                    type: 'line',
                    data: {
                        labels: newCasesTrendData.map(item => 
                            new Date(item.month).toLocaleDateString('en-US', { month: 'short', year: 'numeric' })
                        ),
                        datasets: [{
                            label: 'New Cases',
                            data: newCasesTrendData.map(item => item.count),
                            borderColor: '#0068c9',
                            backgroundColor: '#e6f0ff',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            datalabels: {
                                color: '#333',
                                anchor: 'end',
                                align: 'top',
                                formatter: (value) => value,
                                font: {
                                    weight: 'bold'
                                }
                            },
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1 }
                            }
                        }
                    }
                }
            );
        }

        // Population Pyramid Chart
        if (document.getElementById('populationPyramidChart')) {
            const ageGroups = ageGroupsData.total;
            charts.populationPyramid = new Chart(
                document.getElementById('populationPyramidChart'),
                {
                    type: 'bar',
                    data: {
                        labels: ageGroups.map(item => item.age_group),
                        datasets: [
                            {
                                label: 'Male',
                                data: ageGroups.map(item => item.male_count * -1),
                                backgroundColor: '#0068c9'
                            },
                            {
                                label: 'Female',
                                data: ageGroups.map(item => item.female_count),
                                backgroundColor: '#ffc107'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        scales: {
                            x: {
                                stacked: false,
                                ticks: {
                                    callback: value => Math.abs(value)
                                }
                            },
                            y: { stacked: true }
                        },
                        plugins: {
                            datalabels: {
                                color: '#333',
                                formatter: (value) => Math.abs(value),
                                font: {
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                }
            );
        }

        // Nationality Chart
        if (document.getElementById('nationalityChart')) {
            charts.nationality = new Chart(
                document.getElementById('nationalityChart'),
                {
                    type: 'doughnut',
                    data: {
                        labels: nationalityData.map(item => item.nationality),
                        datasets: [{
                            data: nationalityData.map(item => item.count),
                            backgroundColor: ['#0068c9', '#ffc107', '#dc3545', '#28a745', '#17a2b8']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'right'
                            },
                            datalabels: {
                                color: 'white',
                                formatter: (value, ctx) => {
                                    let sum = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                    let percentage = (value * 100 / sum).toFixed(1) + "%";
                                    return `${value}\n(${percentage})`;
                                },
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            );
        }

        // Delay Distribution Chart
        if (document.getElementById('delayDistributionChart')) {
            charts.delayDistribution = new Chart(
                document.getElementById('delayDistributionChart'),
                {
                    type: 'bar',
                    data: {
                        labels: Object.keys(delayDistributionData),
                        datasets: [{
                            data: Object.values(delayDistributionData),
                            backgroundColor: '#0068c9',
                            borderColor: '#004c96',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                color: 'white',
                                anchor: 'center',
                                align: 'center',
                                formatter: (value) => value || '',
                                font: {
                                    weight: 'bold'
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1 }
                            }
                        }
                    }
                }
            );
        }

        // Store charts globally
        window.dashboardCharts = charts;

        // Initialize html2canvas after charts are ready
        const script = document.createElement('script');
        script.src = 'https://html2canvas.hertzen.com/dist/html2canvas.min.js';
        script.async = true;
        script.onload = () => {
            html2canvasLoaded = true;

            
            // Initialize snapshot button after library loads
            const snapshotBtn = document.getElementById('snapshotDashboardBtn');
            if (snapshotBtn) {
                snapshotBtn.addEventListener('click', captureDashboard);
               
            }
        };
        script.onerror = () => {
            console.error('Failed to load html2canvas');
            const snapshotBtn = document.getElementById('snapshotDashboardBtn');
            if (snapshotBtn) {
                snapshotBtn.disabled = true;
                snapshotBtn.title = 'Failed to load snapshot functionality';
            }
        };
        document.head.appendChild(script);

    } catch (error) {
        console.error('Error initializing charts:', error);
    }

    // Add double-click handlers for all chart containers
    document.querySelectorAll('.chart-container').forEach(container => {
        container.addEventListener('dblclick', function(e) {
            const chartCanvas = this.querySelector('canvas');
            if (!chartCanvas) return;
            
            const chartId = chartCanvas.id;
            const chartKey = chartId.replace('Chart', '');
            const chart = window.dashboardCharts[chartKey];
            
            if (chart) {
                showChartInModal(chart, chartId);
            } else {
                console.error('Chart not found:', chartKey);
            }
        });
    });

    // Add modal cleanup on hide
    const chartModal = document.getElementById('chartModal');
    if (chartModal) {
        chartModal.addEventListener('hidden.bs.modal', function () {
            if (window.modalChart && typeof window.modalChart.destroy === 'function') {
                window.modalChart.destroy();
                window.modalChart = null;
            }
            // Clear the canvas
            const modalCanvas = document.getElementById('modalChart');
            const ctx = modalCanvas.getContext('2d');
            ctx.clearRect(0, 0, modalCanvas.width, modalCanvas.height);
        });
    }
});

// Update the showChartInModal function
function showChartInModal(sourceChart, chartId) {
    const chartModal = new bootstrap.Modal(document.getElementById('chartModal'));
    const modalTitle = document.querySelector('#chartModal .modal-title');
    const modalCanvas = document.getElementById('modalChart');
    
    // Set the modal title based on chart ID
    const titles = {
        'newCasesTrendChart': 'New Cases Trend',
        'populationPyramidChart': 'Age & Gender Distribution',
        'nationalityChart': 'Nationality Distribution',
        'delayDistributionChart': 'Time to Start Treatment KPI'
    };
    modalTitle.textContent = titles[chartId] || chartId;

    // Destroy existing chart if it exists
    if (window.modalChart && typeof window.modalChart.destroy === 'function') {
        window.modalChart.destroy();
    }

    // Clear the canvas
    const ctx = modalCanvas.getContext('2d');
    ctx.clearRect(0, 0, modalCanvas.width, modalCanvas.height);

    // Create new chart in modal
    window.modalChart = new Chart(modalCanvas, {
        type: sourceChart.config.type,
        data: JSON.parse(JSON.stringify(sourceChart.config.data)),
        options: {
            ...sourceChart.config.options,
            maintainAspectRatio: false,
            responsive: true,
            plugins: {
                ...sourceChart.config.options.plugins,
                datalabels: sourceChart.config.options.plugins.datalabels
            }
        }
    });

    chartModal.show();
}

// Update the captureDashboard function
async function captureDashboard() {
    const button = document.getElementById('snapshotDashboardBtn');
    const originalText = button.innerHTML;

    try {
        // Show loading state
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Processing...';
        button.disabled = true;

        // Get the dashboard container
        const dashboard = document.querySelector('.container-fluid');
        if (!dashboard) {
            throw new Error('Dashboard container not found');
        }

        // Elements to hide temporarily
        const elementsToHide = [
            document.querySelector('.card.mb-4'), // Filter card
            ...document.querySelectorAll('.nav-tabs'),
            ...document.querySelectorAll('.fa-download'),
            document.getElementById('loadingOverlay'),
            document.querySelector('.btn-outline-secondary')
        ].filter(Boolean);

        // Store original display values
        const originalDisplays = elementsToHide.map(el => el.style.display);
        
        // Hide elements
        elementsToHide.forEach(el => el.style.display = 'none');

        // Add timestamp at the top
        const headerDiv = document.createElement('div');
        headerDiv.style.padding = '10px';
        headerDiv.style.marginBottom = '10px';
        headerDiv.style.borderBottom = '1px solid #ddd';
        headerDiv.style.backgroundColor = 'white';
        
        const timestamp = document.createElement('div');
        timestamp.style.fontSize = '12px';
        timestamp.style.color = '#666';
        timestamp.textContent = `Dashboard snapshot taken: ${new Date().toLocaleString()}`;
        
        headerDiv.appendChild(timestamp);
        dashboard.insertBefore(headerDiv, dashboard.firstChild);

        // Update KPI values to ensure they're visible
        const avgDaysElement = document.getElementById('avgDays');
        if (avgDaysElement) avgDaysElement.style.display = 'block';
        
        const achievementRateElement = document.getElementById('achievementRate');
        if (achievementRateElement) achievementRateElement.style.display = 'block';

        // Wait for any animations to complete
        await new Promise(resolve => setTimeout(resolve, 1000));

        try {
            // Capture the dashboard
            const canvas = await html2canvas(dashboard, {
                scale: 2,
                backgroundColor: 'white',
                logging: true,
                allowTaint: true,
                useCORS: true,
                width: dashboard.offsetWidth,
                height: dashboard.scrollHeight,
                windowWidth: dashboard.offsetWidth,
                windowHeight: dashboard.scrollHeight
            });

            // Remove the timestamp header
            dashboard.removeChild(headerDiv);

            // Try clipboard first, fall back to download
            try {
                const blob = await new Promise((resolve, reject) => {
                    canvas.toBlob(blob => blob ? resolve(blob) : reject('Blob creation failed'), 'image/png');
                });
                
                await navigator.clipboard.write([
                    new ClipboardItem({ 'image/png': blob })
                ]);
                
                button.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
                button.classList.add('btn-success');
            } catch (clipboardError) {
                console.log('Clipboard failed, falling back to download:', clipboardError);
                const link = document.createElement('a');
                link.download = `KHCC_Dashboard_${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                button.innerHTML = '<i class="fas fa-check me-1"></i>Downloaded!';
                button.classList.add('btn-success');
            }
        } finally {
            // Restore hidden elements
            elementsToHide.forEach((el, i) => {
                if (el) el.style.display = originalDisplays[i];
            });

            // Make sure timestamp is removed if something fails
            if (headerDiv.parentNode === dashboard) {
                dashboard.removeChild(headerDiv);
            }
        }
    } catch (err) {
        console.error('Failed to capture dashboard:', err);
        alert(`Failed to capture dashboard: ${err.message}`);
        button.innerHTML = '<i class="fas fa-times me-1"></i>Failed!';
        button.classList.add('btn-danger');
    } finally {
        // Reset button after 2 seconds
        setTimeout(() => {
            button.innerHTML = originalText;
            button.disabled = false;
            button.classList.remove('btn-success', 'btn-danger');
            button.classList.add('btn-outline-primary');
        }, 2000);
    }
}

// Update the copyChartToClipboard function
async function copyChartToClipboard() {
    try {
        const modalChart = document.getElementById('modalChart');
        const button = document.querySelector('#chartModal .btn-outline-primary');
        const chartTitle = document.querySelector('#chartModal .modal-title').textContent;
        
        // Temporarily change button text to show loading
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Copying...';
        
        // Get active filters
        const activeFilters = getActiveFilters();
        const filterText = activeFilters.length ? `Filters: ${activeFilters.join(' | ')}` : 'No filters applied';
        const timestampText = `Snapshot taken: ${new Date().toLocaleString()}`;
        
        // Create a new canvas with space for title and footer
        const combinedCanvas = document.createElement('canvas');
        const padding = 20;
        const titleHeight = 40;
        const footerHeight = activeFilters.length ? 60 : 40; // More height if we have filters
        combinedCanvas.width = modalChart.width;
        combinedCanvas.height = modalChart.height + titleHeight + footerHeight + (padding * 2);
        
        const ctx = combinedCanvas.getContext('2d');
        
        // Fill white background
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, combinedCanvas.width, combinedCanvas.height);
        
        // Add title
        ctx.fillStyle = '#333';
        ctx.font = 'bold 16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(chartTitle, combinedCanvas.width / 2, padding + 10);
        
        // Draw line under title
        ctx.strokeStyle = '#ddd';
        ctx.beginPath();
        ctx.moveTo(padding, titleHeight);
        ctx.lineTo(combinedCanvas.width - padding, titleHeight);
        ctx.stroke();
        
        // Draw the chart below the title
        ctx.drawImage(modalChart, 0, titleHeight + padding);
        
        // Add filters and timestamp at the bottom
        ctx.fillStyle = '#666';
        ctx.font = '12px Arial';
        ctx.textAlign = 'left';
        
        // Draw line above footer
        ctx.strokeStyle = '#ddd';
        ctx.beginPath();
        ctx.moveTo(padding, combinedCanvas.height - footerHeight);
        ctx.lineTo(combinedCanvas.width - padding, combinedCanvas.height - footerHeight);
        ctx.stroke();
        
        // Add filters if any
        if (activeFilters.length) {
            ctx.fillText(filterText, padding, combinedCanvas.height - footerHeight + 20);
        }
        
        // Add timestamp
        ctx.fillText(timestampText, padding, combinedCanvas.height - 20);
        
        // Convert combined canvas to blob
        const blob = await new Promise(resolve => combinedCanvas.toBlob(resolve, 'image/png'));
        
        // Create ClipboardItem
        const item = new ClipboardItem({ "image/png": blob });
        
        // Copy to clipboard
        await navigator.clipboard.write([item]);
        
        // Show success feedback
        button.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
        button.classList.remove('btn-outline-primary');
        button.classList.add('btn-success');
        
        // Reset button after 2 seconds
        setTimeout(() => {
            button.innerHTML = originalText;
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-primary');
        }, 2000);
        
    } catch (err) {
        console.error('Failed to copy chart:', err);
        alert('Failed to copy chart to clipboard. Please try again.');
    }
}

// Add this helper function to get active filters
function getActiveFilters() {
    const filters = [];
    const form = document.getElementById('filterForm');
    
    // Check date range
    const startDate = form.querySelector('[name="startDate"]').value;
    const endDate = form.querySelector('[name="endDate"]').value;
    if (startDate && endDate) {
        filters.push(`Date: ${new Date(startDate).toLocaleDateString()} - ${new Date(endDate).toLocaleDateString()}`);
    }
    
    // Check gender
    const gender = form.querySelector('[name="gender"]').value;
    if (gender) {
        filters.push(`Gender: ${gender}`);
    }
    
    // Check nationality
    const nationality = form.querySelector('[name="nationality"]').value;
    if (nationality) {
        filters.push(`Nationality: ${nationality}`);
    }
    
    // Check doctors
    const oncologist = form.querySelector('[name="oncologist"]').value;
    if (oncologist) {
        filters.push(`Oncologist: ${oncologist}`);
    }
    
    const surgeon = form.querySelector('[name="surgeon"]').value;
    if (surgeon) {
        filters.push(`Surgeon: ${surgeon}`);
    }
    
    const radiotherapist = form.querySelector('[name="radiotherapist"]').value;
    if (radiotherapist) {
        filters.push(`Radiotherapist: ${radiotherapist}`);
    }
    
    return filters;
}

// Update the fallback function to also include filters and timestamp
function fallbackCopyChartToClipboard() {
    const modalChart = document.getElementById('modalChart');
    const chartTitle = document.querySelector('#chartModal .modal-title').textContent;
    
    // Get active filters
    const activeFilters = getActiveFilters();
    const filterText = activeFilters.length ? `Filters: ${activeFilters.join(' | ')}` : 'No filters applied';
    const timestampText = `Snapshot taken: ${new Date().toLocaleString()}`;
    
    // Create combined canvas with title and footer
    const combinedCanvas = document.createElement('canvas');
    const padding = 20;
    const titleHeight = 40;
    const footerHeight = activeFilters.length ? 60 : 40; // More height if we have filters
    combinedCanvas.width = modalChart.width;
    combinedCanvas.height = modalChart.height + titleHeight + footerHeight + (padding * 2);
    
    const ctx = combinedCanvas.getContext('2d');
    
    // Fill white background
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, combinedCanvas.width, combinedCanvas.height);
    
    // Add title
    ctx.fillStyle = '#333';
    ctx.font = 'bold 16px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(chartTitle, combinedCanvas.width / 2, padding + 10);
    
    // Draw line under title
    ctx.strokeStyle = '#ddd';
    ctx.beginPath();
    ctx.moveTo(padding, titleHeight);
    ctx.lineTo(combinedCanvas.width - padding, titleHeight);
    ctx.stroke();
    
    // Draw the chart below the title
    ctx.drawImage(modalChart, 0, titleHeight + padding);
    
    // Draw line above footer
    ctx.strokeStyle = '#ddd';
    ctx.beginPath();
    ctx.moveTo(padding, combinedCanvas.height - footerHeight);
    ctx.lineTo(combinedCanvas.width - padding, combinedCanvas.height - footerHeight);
    ctx.stroke();
    
    // Add filters if any
    ctx.fillStyle = '#666';
    ctx.font = '12px Arial';
    ctx.textAlign = 'left';
    if (activeFilters.length) {
        ctx.fillText(filterText, padding, combinedCanvas.height - footerHeight + 20);
    }
    
    // Add timestamp
    ctx.fillText(timestampText, padding, combinedCanvas.height - 20);
    
    // Create download link
    const fileName = `KHCC_${chartTitle.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.png`;
    const link = document.createElement('a');
    link.download = fileName;
    link.href = combinedCanvas.toDataURL('image/png');
    
    // Trigger download
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Check for clipboard support when the page loads
document.addEventListener('DOMContentLoaded', function() {
    if (!navigator.clipboard || !navigator.clipboard.write) {
        // Replace the copy function with download function if clipboard API is not supported
        window.copyChartToClipboard = fallbackCopyChartToClipboard;
        
        // Update button text to reflect the action
        const button = document.querySelector('#chartModal .btn-outline-primary');
        if (button) {
            button.innerHTML = '<i class="fas fa-download me-1"></i>Download';
        }
    }
});
</script>
{% endblock %} 






